<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
	<meta charset="utf-8" />
	<title>List of Awesome</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicon/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon/favicon-16x16.png">
	<link rel="icon" type="image/x-icon" href="/assets/img/favicon/favicon.ico" />
	<link rel="manifest" href="/assets/img/favicon/site.webmanifest">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="theme-color" content="#ffffff">

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-touch-fullscreen" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta content="" name="description" />
	<meta content="Luke Vink" name="author" />

	<link href="../assets/plugins/pace/pace-theme-flash.css" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/font-awesome-5/css/all.css" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/jquery-scrollbar/jquery.scrollbar.css" media="screen" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/select2/css/select2.min.css" media="screen" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/jquery-datatable/media/css/jquery.dataTables.css" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/jquery-datatable/extensions/FixedColumns/css/dataTables.fixedColumns.min.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link href="../assets/plugins/datatables-responsive/css/datatables.responsive.css" media="screen" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/bootstrap-tag/bootstrap-tagsinput.css" rel="stylesheet" type="text/css">
	<link href="../assets/plugins/swiper6.4.15/swiper-bundle.min.css" rel="stylesheet">
	<link href="../assets/plugins/pace/minimal.css" rel="stylesheet" type="text/css">


	<link class="main-stylesheet" href="../pages/css/themes/achtung.css" rel="stylesheet" type="text/css" />
	<link class="main-stylesheet" href="../assets/css/style.css" rel="stylesheet" type="text/css" />


		<script defer="" src="/__/firebase/8.2.9/firebase-app.js"></script>
		<script defer="" src="/__/firebase/8.2.9/firebase-auth.js"></script>
		<script defer="" src="/__/firebase/8.2.9/firebase-firestore.js"></script>
		<script defer="" src="/__/firebase/8.2.9/firebase-storage.js"></script>
		<script defer="" src="/__/firebase/8.2.9/firebase-analytics.js"></script>
		<script defer="" src="/__/firebase/8.2.9/firebase-remote-config.js"></script>
		<script defer="" src="/__/firebase/8.2.9/firebase-performance.js"></script>
    <!--
      initialize the SDK after all desired features are loaded, set useEmulator to false
      to avoid connecting the SDK to running emulators.
    -->
    <script defer="" src="/__/firebase/init.js?useEmulator=true"></script>


</head>

<body class="fixed-header menu-pin menu-behind">
	<nav class="page-sidebar" data-pages="sidebar">
		<!-- BEGIN SIDEBAR MENU TOP TRAY CONTENT-->
		<div class="sidebar-overlay-slide from-top" id="appMenu"></div><!-- END SIDEBAR MENU TOP TRAY CONTENT-->
		<!-- BEGIN SIDEBAR MENU HEADER-->
		<div class="sidebar-header"></div><!-- END SIDEBAR MENU HEADER-->
		<!-- START SIDEBAR MENU -->
		<div class="sidebar-menu">
			<!-- BEGIN SIDEBAR MENU ITEMS-->
			<ul class="menu-items">
				<li class="m-t-30">
					<a href="../"><span class="title">All People</span></a> <span class="icon-thumbnail"><i class="pg-icon">users</i></span>
				</li>
				<li class="">
					<a href="../add"><span class="title">Add Person</span></a> <span class="icon-thumbnail"><i class="pg-icon">user_add</i></span>
				</li>
				<li class="">
					<a href="../review"><span class="title">Needs Review</span></a> <span class="icon-thumbnail"><i class="pg-icon" id="menu-review-icon">star</i></span>
				</li>
				<li class="">
					<a href="../lists"><span class="title">My Lists</span></a> <span class="icon-thumbnail"><i class="pg-icon">pin</i></span>
				</li>
				<li class="active">
					<a href="../settings"><span class="title">Settings</span></a> <span class="icon-thumbnail"><i class="pg-icon">cog</i></span>
				</li>
			</ul>
			<div class="clearfix"></div>
		</div><!-- END SIDEBAR MENU -->
	</nav><!-- END SIDEBAR -->
	<!-- END SIDEBAR -->
	<!-- START PAGE-CONTAINER -->
	<div class="page-container">
		<div class="filter-modal-shade" id="sidebar-modal-shade"></div><!-- START PAGE HEADER WRAPPER -->
		<!-- START HEADER -->
		<div class="header">
			<!-- START MOBILE SIDEBAR TOGGLE -->
			<a class="btn-link toggle-sidebar d-lg-none pg-icon btn-icon-link" data-toggle="sidebar" href="#">menu</a> <!-- END MOBILE SIDEBAR TOGGLE -->
			<div class="">
				<div class="brand inline m-l-10"><img alt="logo" data-src="../assets/img/logo.png" data-src-retina="../assets/img/logo.png" height="50" src="../assets/img/logo.png"></div><!--                <a href="#" class="search-link d-lg-inline-block d-none" style="margin-left:50px;" data-toggle="search"><i class="pg-icon">search</i>Type anywhere to <span class="bold">search</span></a> -->
			</div>
			<div class="d-flex align-items-center">
				<!-- START User Info-->
				<div class="dropdown pull-right d-lg-block">
					<button aria-expanded="false" aria-haspopup="true" aria-label="profile dropdown" class="profile-dropdown-toggle" data-toggle="dropdown" type="button"><span class="thumbnail-wrapper d32 circular inline"><img height="32" id="account-photo" src="../assets/img/profiles/0.png" width="32"></span></button>
					<div class="dropdown-menu dropdown-menu-right profile-dropdown" role="menu">
						<a class="dropdown-item" href="#"><span>Signed in as<br>
						<b><span id="account-name">Achtung!<span></span></span></b></span></a>
						<div class="dropdown-divider"></div><a class="dropdown-item">Settings</a> <a class="dropdown-item" id="sign-out">Sign Out</a>
					</div>
				</div><!-- END User Info-->
			</div>
		</div><!-- END HEADER -->
		<!-- END PAGE HEADER WRAPPER -->
		<!-- START PAGE CONTENT WRAPPER -->
		<div class="page-content-wrapper">
			<!-- START PAGE CONTENT -->
			<div class="content">
				<!-- START CONTAINER FLUID -->
				<div class="container-fluid">
					<!-- BEGIN PlACE PAGE CONTENT HERE -->
					<div class="d-flex row" style="margin-top:24px;">
						<div class="col-12">
							<h4 class="mw-80 m-b-40">Settings</h4>
						</div>
					</div><!-- BEGIN USERS  -->
					<div class="d-flex row">
						<div class="col-12">
							<div class="card card-default">
								<div class="card-header">
									<div class="card-title">
										Account
									</div>
								</div>
								<div class="card-block" style="padding:0 20px 20px 20px;">
									<div class="d-flex">
										<div class="col-xl-6 col-lg-6">
											<h4 id="account-displayname"></h4>
											<p id="account-email"></p>
											<p id="account-isadmin"></p>
										</div>
										<div class="col-xl-6 col-lg-6" style="display:flex; justify-content: flex-end; text-align:right;">
											<div class="avatar" id="account-profileImage" style=""></div>
										</div>
									</div>
								</div>
							</div><!-- BEGIN CARD -->
							<div class="card card-default" id="skills-card">
								<div class="card-header">
									<div class="card-title">
										Skills tags
									</div>
								</div>
								<div class="card-block" style="padding:0 20px 20px 20px;">
									<div class="d-flex category-row">
										<div class="col-3 no-padding">
											<h6>Category</h6>
										</div>
										<div class="col-8 no-padding">
											<h6>Tags</h6>
										</div>
										<div class="col-1 no-padding" style="text-align: center;">
											<button aria-label="Add new category" class="edit-button btn btn-achtung btn-animated from-top" data-placement="left" data-toggle="tooltip" id="skills-add-category" style="width:78%" title="Add a category" type="button"><span><i class="pg-icon">add</i></span> <span class="hidden-block"><i class="pg-icon">add</i></span></button>
										</div>
									</div>
									<form role="form">
										<div id="skills-editor"></div>
									</form>
									<div class="d-flex category-row" style="margin-top:20px">
										<div class="col-6 no-padding">
											<i class="text-danger"></i>
											<p class="small-text"><i class="text-danger">*editing these tags does not affect the tags added to contacts, just the options in filters and adding a person. You may need to re-add / change tags to contacts.</i></p>
										</div>
										<div class="col-6 no-padding" style="text-align: right;">
											<button aria-label="Save all skills tags" class="btn btn-lg btn-rounded btn-primary m-r-10 m-b-10" disabled id="skills-save" type="button"><span><i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">save</i> Save all skills tags</span></button>
										</div>
									</div>
								</div>
							</div> <!-- END CARD -->

							<div class="card card-default" id="users-card">
								<div class="card-header">
									<div class="card-title">
										User Accounts & Roles
									</div>
								</div>
								<div class="card-block" style="padding:0 20px 20px 20px;">
									<div class="search-wrapper">
										<input class="form-control pull-right" id="search-table-full" placeholder="Search" type="text">
									</div><!-- BEGIN TABLE -->
									<div class="hideMe" id="contactTableWrapper">
										<table cellspacing="0" class="table table-hover" id="usersTable" width="100%">
											<thead>
												<tr>
													<th>Name</th>
													<th>Email</th>
													<th class="no-sort">Role</th><!-- <th class="no-sort">
															</th> -->
												</tr>
											</thead>
											<tbody></tbody>
										</table>
									</div> <!-- END TABLE -->
								</div>
							</div> <!-- END CARD -->

							<div class="card card-default" id="upload-card">
								<div class="card-header">
									<div class="card-title">
										Import People from CSV File (Spreadsheet)
									</div>
								</div>
								<div class="card-block" style="padding:0 20px 20px 20px;">
									<div class="d-flex category-row" style="margin-top:20px">
										<div class="col-5 no-padding">
											<div id="dvImportSegments" class="fileupload ">
												<fieldset>
													<input type="file" name="File Upload" id="txtFileUpload" accept=".csv" />
												</fieldset>
											</div>
										</div>
										<div class="col-7 no-padding" style="text-align: right;">
											<button id="import-errors" class="btn btn-danger">Errors</button>
											<button id="import-success" class="btn btn-success">people can be added</button>
											<div id="import-progress" class="hideMe">
												<div class="progress-circle-indeterminate" style="display: block;"></div>
											</div> 
										</div>
									</div>
									
										<div class="hideMe" id="uploadErrors">
											<table cellspacing="0" class="table table-hover" id="uploadErrorTable" width="100%">
												<thead>
													<tr>
														<th class="no-sort">Row</th>
														<th class="no-sort">Name</th>
														<th class="no-sort">Email</th>
														<th class="no-sort">Error</th>
													</tr>
												</thead>
												<tbody></tbody>
											</table>
										</div> <!-- END TABLE -->

									<div class="d-flex category-row" style="margin-top:20px">
										<div class="col-6 no-padding">
											<i class="text-danger"></i>
											<p class="small-text"><i class="text-danger">*Make sure to upload a CSV file exported from sheets that follows this EXACT template. Some fields are required (<b>*First & *last name, *skills/tags and *email</b>). If a person does not have this they will not be imported</i></p>
										</div>
										<div class="col-6 no-padding" style="text-align: right;">
											<button aria-label="Save all skills tags" class="btn btn-lg btn-rounded btn-primary m-r-10 m-b-10" disabled id="import-people" type="button"><span><i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">add_user</i> Import people</span></button>
										</div>
									</div>

								</div>
							</div><!-- END CARD -->


						</div>
					</div>
				</div><!-- END CONTAINER FLUID -->
			</div><!-- END PAGE CONTENT -->
		</div><!-- END PAGE CONTENT WRAPPER -->
	</div><!-- END PAGE CONTAINER -->


	<!-- BEGIN VENDOR JS -->
	<!-- BEGIN VENDOR JS -->
	<script type="text/javascript" src="../assets/plugins/classie/classie.js" ></script>
    <script type="text/javascript" src="../assets/plugins/pace/pace.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/jquery/jquery-3.2.1.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/modernizr.custom.js" ></script>
    <script type="text/javascript" src="../assets/plugins/jquery-ui/jquery-ui.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/popper/umd/popper.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/bootstrap/js/bootstrap.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/jquery/jquery-easy.js" ></script>
    <script type="text/javascript" src="../assets/plugins/jquery-unveil/jquery.unveil.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/jquery-ios-list/jquery.ioslist.min.js" ></script>
    <script type="text/javascript" src="../assets/plugins/jquery-actual/jquery.actual.min.js"></script>
    <script type="text/javascript" src="../assets/plugins/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script type="text/javascript" src="../assets/plugins/jquery-datatable/media/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="../assets/plugins/jquery-datatable/extensions/TableTools/js/dataTables.tableTools.min.js"></script>
	<script type="text/javascript" src="../assets/plugins/jquery-datatable/extensions/Bootstrap/jquery-datatable-bootstrap.js"></script>
	<script type="text/javascript" src="../assets/plugins/datatables-responsive/js/datatables.responsive.js" ></script>
	<script type="text/javascript" src="../assets/plugins/datatables-responsive/js/lodash.min.js" ></script>
	<script type="text/javascript" src="../assets/plugins/swiper6.4.15/swiper-bundle.min.js"></script>
	<script type="text/javascript" src="../assets/plugins/bootstrap-tag/bootstrap-tagsinput.min.js"></script>
	<script type="text/javascript" src="../assets/plugins/jquery-csv-1.0.21/src/jquery.csv.min.js"></script>

	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <!-- BEGIN CORE TEMPLATE JS -->
    <script type="text/javascript" src="../pages/js/pages.min.js" type="text/javascript"></script>
    <!-- END CORE TEMPLATE JS -->


	<!-- LoginETC -->
	<script>


		var swiper;
		var currentPersonUid;
		var currnetUser;
		var isAdmin;

		//////////////////////// INIT TABLE /////////////////////////

		var settings = {
							"sDom": "<t><'row'<p i>>",
							"destroy": true,
							"scrollCollapse": true,
							"oLanguage": {
									"sLengthMenu": "_MENU_ ",
									"sInfo": "Showing <b>_START_ to _END_</b> of _TOTAL_ entries"
							},
							"scrollX": true,
					bLengthChange : false,
					lengthChange: false,
					"pagingType": "numbers",
					columnDefs: [
					 { orderable: false, targets: -1 }
				 ],
				 'createdRow': function(row, data, dataIndex){
			      $('td:eq(6)', row).css('min-width', '100px');
			   },
					"fnDrawCallback": function(oSettings) {
								$('.dataTables_scrollHead').hide();
							 if ($('#example tr').length < 11) {
									 $('.dataTables_paginate').hide();
									 $('.dataTables_info').hide();
							 }
					 }
		};

		var usersTable = $('#usersTable').DataTable(settings);

		// search box for table
		$('#search-table-full').keyup(function() {
			usersTable.search($(this).val()).draw();
		});


		//////////////////////// USER HANDLING /////////////////////////

		document.addEventListener('DOMContentLoaded', () => {
			const db = firebase.firestore();

			firebase.auth().onAuthStateChanged((user) => {
				if(user){

					if(user.photoURL)
						$('#account-photo').attr("src", user.photoURL);
						$('#account-profileImage').css('background-image', 'url(' + user.photoURL + ')' )

					if(user.displayName)
						$('#account-name').html(user.displayName);

						$('#account-displayname').html(user.displayName);
						$('#account-email').html(user.email);


					var userdoc = db.collection("users").doc(user.uid).get().then((doc) => {
							if (doc.exists) {
								if (doc.data().isAdmin) {
									isAdmin = true;
									console.log("User is an Admin");
									$('#users-card').show();
									$('#skills-card').show();
									$('#upload-card').show();
									$('#account-isadmin').html('Admin');
								} else {
									console.log("User is not an Admin");
									$('#account-isadmin').html('Author');
									$('#users-card').empty();
									$('#skills-card').empty();
									$('#upload-card').empty();
									isAdmin = false;
								}
							} else {
									console.log("No such document!");
									window.location.href = '../error';
							}
					}).catch((error) => {
							console.log("Error getting document:", error);
					});

				} else {
					window.location.href = '../login';
				}

			});

			$('#sign-out').click(function() { firebase.auth().signOut() });




			//SETUP SKILL EDITOR
			var skillGroups = '';
			var skillEditorHTML = '';
			var count = 0;
			db.collection("skills").orderBy("title", "asc").get().then((querySnapshot) => {

					
					querySnapshot.forEach((doc) => {
							var options = '';
							var optionsArray = doc.data().options;
							optionsArray.sort();
							optionsArray.forEach((option) => {
								if(options == ''){
									options = options + option;
								} else {
									options = options + ',' + option;
								}
							});
							var skillGroup = createSkillsRow(doc.id, doc.data().title, options);
							$("#skills-editor").append(skillGroup);
							count++;

					});

					$('.delete-skill-row').click(function() {
						 $(this).parent().parent().parent().remove();
						 $('#skills-save')[0].disabled = false;
					});




					setTimeout(() =>{
						$('.bootstrap-tagsinput input').keypress(() => {
							$('#skills-save')[0].disabled = false;
							$('#skills-save').html('<span> <i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">save</i> Save all skills tags</span>');
						});
						$('.category-title').change(() => {
							$('#skills-save')[0].disabled = false;
							$('#skills-save').html('<span> <i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">save</i> Save all skills tags</span>');
						});
						$('.skills-tags').on('itemRemoved', function(event) {
							$('#skills-save')[0].disabled = false;
							$('#skills-save').html('<span> <i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">save</i> Save all skills tags</span>');
						});
						$('#skills-save')[0].disabled = true;
					}, 300);


					$(function () {

						$(function () {
							 $('input[data-role=tagsinput]').tagsinput();
					 });
							//  $('input[data-role=tagsinput]').tagsinput({ 
							// 	 trimValue: true,
							// 	allowDuplicates: true,
							// 	freeInput: true
							// });
							
							//  $('.bootstrap-tagsinput').sortable({
							// 	update: function() {
							// 		var $self = $(this);
							// 		var tags = $self.find('span.tag').map(function(){return $(this).text();}).get();
							// 		$self.parent().find('input[class!="ui-sortable-handle"]').val(tags.join(','));
							// 		$('#skills-save')[0].disabled = false;
							// 	}
							// });
					 });

			});



			function createSkillsRow(id, title, options){

				var html = '<div class="d-flex category-row skill-row" data-uid="'+ id +'">' +
													'<div class="col-3 no-padding">' +
														'<div class="form-group form-group-default">' +
															'<input type="text" value="' + title + '" class="form-control category-title" placeholder="Enter category name">' +
														'</div>' +
													'</div>' +
													'<div class="col-8 no-padding">' +
														'<div class="form-group form-group-default form-group-right">' +
															'<input class="skills-tags" type="text" value="'+ options +'" data-role="tagsinput" placeholder="click to add tags" >' +
														'</div>' +
													'</div>' +
													'<div class="col-1 no-padding">' +
														'<div class="form-group form-group-default form-group-right no-focus">' +
															'<button  aria-label="Delete" data-uid="'+ id + '" type="button" class="delete-skill-row btn btn-achtung btn-animated from-top"> <span> <i class="pg-icon">trash_alt</i> </span> <span class="hidden-block"> <i class="pg-icon">trash_alt</i> </span> </button>'
														'</div>' +
													'</div>' +
												'</div>';

				return html;
			}




			$('#skills-add-category').click(function() {
				 $("#skills-editor").append(createSkillsRow('', '', ''));
				 $("#skills-editor .skills-tags").tagsinput('items');
				 $('.delete-skill-row').click(function() {
						$(this).parent().parent().parent().remove();
						$('#skills-save')[0].disabled = false;
				 });
				 $('#skills-save')[0].disabled = false;
			});

			$('#skills-save').click(function() {
				firebase.firestore().collection('skills').get().then(querySnapshot => {
				    querySnapshot.docs.forEach(snapshot => {
				        snapshot.ref.delete();
				    });
						$( ".skill-row" ).each(function() {
							firebase.firestore().collection("skills").add({
							    title: $( this ).find('.category-title').val(),
							    options: $( this ).find('.skills-tags').tagsinput('items')
							});
						});
						$('#skills-save').html('<span> <i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">tick_circle</i> Skills updated!</span>');

						setTimeout(function(){
							$('#skills-save').html('<span> <i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">save</i> Save all skills tags</span>');
							$('#skills-save')[0].disabled = true;
						}, 1500);
				});
			});



			function changeUserRole(userUid, role){
				if(role == 'true'){
					db.collection("users").doc(userUid).update({
					    "isAdmin": true
					}).then(() => {
					    console.log("Role changed to " + role);
					});
				} else {
					db.collection("users").doc(userUid).update({
					    "isAdmin": false
					}).then(() => {
					    console.log("Role changed to " + role);
					});
				}

			}

			//SHOW REVIEW COUNT
			db.collection("contacts").where("approvedStatus", "==", "pending").get().then(function(querySnapshot) {
				var count = 0;
				querySnapshot.forEach(function(doc) {
					count ++
				});
				if(count > 0){$("#menu-review-icon").html(count).addClass('highlight')}
			});

			function addUsersToTable() {

				db.collection("users").get().then((querySnapshot) => {
					querySnapshot.forEach(function(doc) {
 						usersTable.row.add([
							makeAvatarDisplayName(doc.data()),
							doc.data().email,
							makeRole(doc),
							// '<button aria-label="" data-uid="'+ doc.data().id + '" type="button" class="btn btn-achtung btn-animated from-top"> <span> <i class="pg-icon">edit</i> </span> <span class="hidden-block"> <i class="pg-icon">edit</i> </span> </button>'
						]);

						setTimeout(() =>{
							// var el = $(".admin-select[data-uid='" + doc.id + "']").get(0);
							// $(el).wrap('<div class="cs-wrapper"></div>');
							// new SelectFx(el);
						}, 5);

					});

					setTimeout(() =>{
						usersTable.draw();
						$(window).trigger('resize');
						$('.admin-select').on('change', () => {
							changeUserRole($(this).data('uid'),this.value);
						});
					}, 200);

					$('#contactTableWrapper').removeClass('hideMe');

				});

			}
			addUsersToTable();


			function makeAvatarName(person){
				if(person.profileImageUrl){
					return '<div class="flex-cell"><span class="thumbnail-wrapper d32 circular inline"><img src="'+ person.profileImageUrl +'" alt="" data-src="'+ person.profileImageUrl +'" data-src-retina="'+ person.profileImageUrl +'" width="32" height="32"></span><span class="name">'+ person.firstName + ' ' + person.lastName +'</span></div>'
				} else 	{
					return '<div class="flex-cell"><span class="thumbnail-wrapper d32 circular inline"></span><span class="name">'+ person.firstName + ' ' + person.lastName +'</span></div>'
				}
			}

			function makeAvatarDisplayName(person){
				if(person.profileImageUrl){
					return '<div class="flex-cell"><span class="thumbnail-wrapper d32 circular inline"><img src="'+ person.profileImageUrl +'" alt="" data-src="'+ person.profileImageUrl +'" data-src-retina="'+ person.profileImageUrl +'" width="32" height="32"></span><span class="name">'+ person.displayName +'</span></div>'
				} else 	{
					return '<div class="flex-cell"><span class="thumbnail-wrapper d32 circular inline"></span><span class="name">'+ person.displayName +'</span></div>'
				}
			}

			function makeRole(doc){
				var selectText = '';
				if(doc.data().isAdmin == true){
					selectText = '<select class="cs-select cs-skin-slide admin-select" data-uid="'+doc.id+'" data-init-plugin="cs-select"><option value="false">Author</option><option value="true" selected>Admin</option></select>';
				} else {
					selectText = '<select class="cs-select cs-skin-slide admin-select" data-uid="'+doc.id+'" data-init-plugin="cs-select"><option value="false" selected>Author</option><option value="true">Admin</option></select>';
				}
				return selectText;
			}

			function makeButtons(person){
				var linkshtml = '';

				if(person.website != '' && person.website != undefined)
					linkshtml = linkshtml + '<a target="_blank" href="'+ person.website +'" aria-label="" type="button" class="btn btn-achtung"><span> <i class="fas fa-globe-europe"></i> </span></a>'

				if(person.linkedin != '' && person.linkedin != undefined)
					linkshtml = linkshtml + '<a target="_blank" href="'+ person.linkedin +'" aria-label="" type="button" class="btn btn-achtung"><span> <i class="fab fa-linkedin"></i> </span></a>'

				if(person.instagram != '' && person.instagram != undefined)
					linkshtml = linkshtml + '<a target="_blank" href="'+ person.instagram +'" aria-label="" type="button" class="btn btn-achtung"><span> <i class="fab fa-instagram"></i> </span></a>'

				return linkshtml
			}
			function makePosition(person){
				if(person.status != 'Freelancer'){
					return 	person.jobTitle + ', ' + person.company;
				} else {
					return 	'Freelancer';
				}
			}
			function makeTags(tagArray){
				var html = '';
				tagArray.forEach(function(item) {
				    html = html + ' <button class="btn btn-chip">'+ item +'</button>';
				});
				return html
			}


			//////////////////////// HELPERS /////////////////////////

			$('#sidebar-modal-shade').on('click', () => {
			  $('[data-toggle="sidebar"]').trigger( "click" );
			  $('#sidebar-modal-shade').removeClass('show');

			});

			$(document).on('click.pg.sidebar.data-api', '[data-toggle="sidebar"]', function(e) {
			   $('#sidebar-modal-shade').addClass('show');
			});

			$('.copy-input').on('click', () => {
				   copyText = $(this).find( "input" );
					 copyText.select();
					 document.execCommand("copy");

					 $('body').pgNotification({
						 	style: 'bar',
							message: 'Copied to clipboard!',
							timeout: 1500,
							type: 'success',
							position: 'top'
					 }).show();

				});

				var tagsInput;
				var tagVal;
				$(document).on('click', '.tag', () => {

					if( $(this).has( "input" ).length == 0){

						tagVal = $(this).html();
						tagVal = tagVal.replace('<span data-role="remove"></span>','');
						$(this).addClass('editing');

						var htmlStr = '<input type="text" class="form-control" id="tag-input" style="background-color: white">' +
													'<span data-role="remove"></span>';

						$(this).html(htmlStr);
						var editInput = $('#tag-input');

						editInput.val('');
						editInput.focus();
					}

				});

				$(document).on('focusout', '#tag-input', () => {

					 var tag = $(this).parent();
					 $(this).parent().removeClass('editing');

					 var htmlStr =  $(this).val() + '<span data-role="remove"></span>';

					 if($(this).val() == ''){
						 htmlStr =  tagVal + '<span data-role="remove"></span>';
					 }

					 tag.html(htmlStr);

				 });



				// The event listener for the file upload
				document.getElementById('txtFileUpload').addEventListener('change', upload, false);

				// Method that checks that the browser supports the HTML5 File API
				function browserSupportFileUpload() {
					var isCompatible = false;
					if (window.File && window.FileReader && window.FileList && window.Blob) {
					isCompatible = true;
					}
					return isCompatible;
				}

				$("#import-errors").click(function(){
					$('#uploadErrors').toggleClass('hideMe');
					var errorCSV = $.csv.fromObjects(errorItems);

					let link = document.createElement('a');
					link.setAttribute('style', 'display:none;');
					document.body.appendChild(link);
					let blob = new Blob([errorCSV], { type: 'text/csv' });
					let url = window.URL.createObjectURL(blob);
					link.href = url;
					link.download = 'errors.csv';
					link.click();

				});

				// Method that reads and processes the selected file
				var errorItems = [];
				var goodItems = [];

				function upload(evt) {
					$('#import-progress').removeClass('hideMe');
					$('#import-progress').fadeIn(300);
					$('#import-success').hide();
					$('#import-errors').hide();

					if (!browserSupportFileUpload()) {
						alert('The File APIs are not fully supported in this browser!');
						} else {
							var data = null;
							var file = evt.target.files[0];
							var reader = new FileReader();
							reader.readAsText(file);
							reader.onload = function(event) {

								db.collection("contacts").get().then(function(querySnapshot) {

									var csvData = event.target.result;
									//convert to JS array
									//data = $.csv.toArrays(csvData);
									var items = $.csv.toObjects(csvData);
									var jsonobject = JSON.stringify(items);

									var fullNames = [];

									querySnapshot.forEach(function(doc) {
										var person = doc.data();
										if(person.approvedStatus !== 'rejected')
											fullNames.push(person.firstName + ' ' + person.lastName);
									});

									for (const row in items) {

										var existsAlready = fullNames.includes(items[row].firstName + ' ' + items[row].lastName);


										if(!existsAlready){
													// if(items[row].email != ""){
													// 	if (validateEmail(items[row].email)){
													if(items[row].skills != ""){
														if (typeof items[row].skills === 'string') {
															let skillArr = items[row].skills.split(',');
															items[row].skills = skillArr;
														}
														if(items[row].isCompany ==false){
															fullName = items[row].firstName + ' ' + items[row].lastName;
															if(!fullName.includes('&') && !fullName.includes('(')){
																if(items[row].firstName != ""){
																	if(items[row].lastName != ""){
																		goodItems.push(items[row]);
																	} else {
																		let error = "No Last Name";
																		items[row].error = error;
																		addErrorToTable(row, items[row], error)
																		errorItems.push(items[row]);
																	}
																} else {
																	let error = "No First Name";
																	items[row].error = error;
																	addErrorToTable(row, items[row], error)
																	errorItems.push(items[row]);
																}													
															} else {
																let error = "Name has weird characters, likely multiple names";
																items[row].error = error;
																addErrorToTable(row, items[row], error)
																errorItems.push(items[row]);
															}
														} else {
															goodItems.push(items[row]);
														}
													} else {
														let error = "No skill tags, required";
														items[row].error = error;
														addErrorToTable(row, items[row], error)
														errorItems.push(items[row]);
													}
											// 	} else {
											// 		let error =  items[row].email + " not an email address";
											// 		items[row].error = error;
											// 		addErrorToTable(row, items[row], error)
											// 		errorItems.push(items[row]);
											// 	}
											// } else {
											// 	let error = "No email address";
											// 	items[row].error = error;
											// 	addErrorToTable(row, items[row], error)
											// 	errorItems.push(items[row]);
											// }
										} else {
											let error = "Already added to list!!";
											items[row].error = error;
											addErrorToTable(row, items[row], error)
											errorItems.push(items[row]);
										}

										$('import-progress-bar').val(map_range(row, 0, items.lemgth, 0, 100)); 

									}     

									console.log(errorItems);
									$('#import-progress').addClass('hideMe');
									$('#import-progress').fadeOut(300);
									$('#import-success').html(goodItems.length + ' people  will be added');
									$('#import-errors').html(errorItems.length + ' errors (click to download)');
									$('#import-people').html('<i class="pg-icon" style="vertical-align: middle; margin-top:-2px; margin-right:5px;">add_user</i>Import ' + goodItems.length + ' people');
									
									setTimeout(function(){
										$('#import-success').fadeIn(200);
										$('#import-errors').fadeIn(200); 
										if(goodItems.length > 0){
											$('#import-people')[0].disabled = false;
										}
									}, 300);

								});



							};
							reader.onerror = function() {
								console.log('Unable to read ' + file.fileName);
							};
						}
					}

					function map_range(value, low1, high1, low2, high2) {
						return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
					}

					var settings2 = {
						"sDom": "<t><'row'<p i>>",
						"paging":   false,
						"ordering": false,
						"info":     false,
						'createdRow': function(row, data, dataIndex){
	                       $('td:eq(0)', row).css('width', '50px');
	                   }
						
					};

					var uploadErrorTable = $('#uploadErrorTable').DataTable(settings2);

					function addErrorToTable( index, row, error) {

						// console.log(`%c` + error , `background: #ff0000; color: #ffffff`);

						uploadErrorTable.row.add([
							parseInt(index) + 2,
							row.firstName + ' ' + row.lastName,
							row.email,
							'Error: '+error,
						]);

						uploadErrorTable.draw();
					}

					function validateEmail(email) {
						const re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
						return re.test(email);
					}

					function importPeople() {
						if(goodItems.length > 0){

							$('#import-people')[0].disabled = true;

							goodItems.forEach(function (person) {
								
								var docData = {	
									firstName: person.firstName,
									lastName: person.lastName,
									email: person.email,
									phone: person.phone || '',
									location: person.location || '',
									jobTitle: person.jobTitle || '',
									company: person.company || '',
									skills: person.skills || [],
									workedOn: person.workedOn || [],
									notes: person.notes || '',
									rating: person.rating || '',
									profileImageUrl: '',
									isCompany: (person.isCompany === "TRUE" ||  person.isCompany === "true"),
									isImported: true,
									website: person.website || '',
									linkedin: person.linkedin || '',
									instagram: person.instagram || '',
									featuredWork: '',
									rate: person.rate || '',
									dayRate: person.dayRate || '',
									approvedStatus: 'approved',
									isImported: true,
									createdAt: firebase.firestore.Timestamp.fromDate(new Date()),
									editedAt: firebase.firestore.Timestamp.fromDate(new Date()),
								}

								db.collection("contacts").doc().set(docData).then(() => {
									console.log(docData.firstName + ' ' + docData.lastName + " successfully added!");
								});

							});

						}
					}

					$("#import-people").click(function(){
						importPeople();
					});


			

				 // $('body').keypress(function (event) {
					//     if (event.keyCode === 10 || event.keyCode === 13  || event.keyCode === 8) {
					//         event.preventDefault();
					//     }
					// });
				 //
					// $('body').keydown(function (e) {
					//   var key = e.keyCode || e.charCode;
					//   if (key == 8 || key == 46) {
					// 		console.log('test');
				 //
					//       e.preventDefault();
					//       e.stopPropagation();
					//   }
					// });




		});// END ON DOM READY


	</script>
	<!-- END PAGE LEVEL JS -->
</body>

</html>
